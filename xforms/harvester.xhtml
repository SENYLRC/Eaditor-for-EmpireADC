<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:ead="urn:isbn:1-931666-22-9"
	xmlns:exist="http://exist.sourceforge.net/NS/exist" xmlns:oai="http://www.openarchives.org/OAI/2.0/" xmlns:oai_dc="http://www.openarchives.org/OAI/2.0/oai_dc/">
	<head>
		<title>EADitor: Edit Settings</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />
		<link rel="stylesheet" href="/config/theme/examples.css" type="text/css" media="all" />
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
		<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="/apps/eaditor/xforms/css/xforms.css" />

		<xforms:model xmlns="urn:isbn:1-931666-22-9">
			<xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema">
				<xsd:simpleType name="url">
					<xsd:restriction base="xsd:string">
						<xsd:pattern value="@^(https?|ftp)://[^\s/$.?#].[^\s]*$@iS"></xsd:pattern>
					</xsd:restriction>
				</xsd:simpleType>
			</xsd:schema>


			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"></xi:include>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<config xmlns=""></config>
			</xforms:instance>

			<xforms:instance id="control-instance" xxforms:exclude-result-prefixes="#all">
				<controls xmlns="">
					<status></status>
					<error></error>
					<interface></interface>
					<validate-trigger>false</validate-trigger>
					<oai-valid></oai-valid>
				</controls>
			</xforms:instance>

			<xforms:instance id="collections-list" xxforms:exclude-result-prefixes="#all">
				<collections xmlns=""></collections>
			</xforms:instance>

			<xforms:instance id="harvesters" xxforms:exclude-result-prefixes="#all">
				<harvesters xmlns=""></harvesters>
			</xforms:instance>

			<xforms:instance id="harvester-template" xxforms:exclude-result-prefixes="#all">
				<harvester collection="" type="oai" url="" date="" xmlns=""></harvester>
			</xforms:instance>

			<!-- OAI-PMH -->
			<xforms:instance id="oai-pmh" xxforms:exclude-result-prefixes="#all">
				<OAI-PMH xmlns=""></OAI-PMH>
			</xforms:instance>

			<!-- XQuery -->
			<xforms:instance id="eXist-xquery">
				<exist:query xmlns="">
					<exist:text></exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="xquery-result">
				<exist:result></exist:result>
			</xforms:instance>

			<xforms:instance id="xqueries">
				<queries xmlns="">
					<query id="collection-metadata">
						<![CDATA[xquery version "1.0";
						declare namespace ead="urn:isbn:1-931666-22-9";
						let $sequence:= tokenize('%SEQUENCE%', ',')
						let $aggregate:=%AGG%()
						return
						<metadata>
							{
							for $collection-name in $sequence
							let $config:= concat('/db/eaditor/', $collection-name, '/config.xml')
							return 
								<collection id="{$collection-name}">
									<title>{if ($aggregate = true()) then data(doc(concat('/db/eaditor/', $collection-name, '/ead-template.xml'))//ead:publisher) else data(doc($config)/config/title)}</title>
									<description>{data(doc($config)/config/description)}</description>
									<url>{data(doc($config)/config/url)}</url>
								</collection>
							}
						</metadata>]]>
					</query>
				</queries>
			</xforms:instance>

			<!-- ************* BINDINGS ************* -->
			<xforms:bind nodeset="instance('config')">
				<xforms:bind nodeset="aggregator" type="xs:boolean"></xforms:bind>
				<xforms:bind id="validate-trigger" nodeset="validate-trigger" type="xs:boolean" readonly=". != true()"></xforms:bind>
			</xforms:bind>

			<xforms:bind nodeset="instance('harvesters')">
				<xforms:bind nodeset="harvester">
					<xforms:bind nodeset="@date" type="xs:date"></xforms:bind>
				</xforms:bind>
			</xforms:bind>

			<xforms:bind nodeset="instance('harvester-template')">
				<xforms:bind nodeset="@collection" required="true()"></xforms:bind>
				<xforms:bind nodeset="@url" required="true()" type="xs:anyURI"></xforms:bind>
			</xforms:bind>

			<!-- **************** DYNAMIC VALIDATION CONTROLS ********************** -->
			<xforms:action ev:event="xxforms-invalid" ev:observer="harvester-template">
				<xforms:setvalue ref="instance('control-instance')/validate-trigger" value="false()"></xforms:setvalue>
			</xforms:action>

			<xforms:action ev:event="xxforms-valid" ev:observer="harvester-template">
				<xforms:setvalue ref="instance('control-instance')/validate-trigger" value="true()"></xforms:setvalue>
			</xforms:action>

			<!-- ************* SUBMISSIONS ************* -->
			<!-- load and save files from eXist -->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/config.xml" replace="instance" instance="config"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error loading config.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-harvesters" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/harvesters.xml" replace="instance"
				instance="harvesters" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:setvalue ref="instance('control-instance')/status" ev:event="xforms-submit-error">No harvesters have been set up yet.</xforms:setvalue>
			</xforms:submission>

			<xforms:submission id="save-harvesters" ref="instance('harvesters')" action="{instance('exist-config')/url}eaditor/harvesters.xml" method="put" replace="none"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error saving harvester XML file.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-collections" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/collections-list.xml" replace="instance"
				instance="collections-list" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:setvalue ref="instance('control-instance')/error" ev:event="xforms-submit-error">Error loading collections list.</xforms:setvalue>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('eXist-xquery')/exist:text"
						value="replace(replace(instance('xqueries')/query[@id='collection-metadata'], '%SEQUENCE%', string-join(instance('collections-list')/collection/@name, ',')), '%AGG%', instance('config')/aggregator)"></xforms:setvalue>
					<xforms:send submission="xquery-db"></xforms:send>
				</xforms:action>
			</xforms:submission>

			<!-- interacting with OAI-PMH -->
			<xforms:submission id="query-oai" serialization="none" method="get" action="{instance('harvester-template')/@url}" replace="instance" instance="oai-pmh">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:setvalue ref="instance('control-instance')/error">The URL does to yield a parseable response (not OAI-PMH).</xforms:setvalue>
				</xforms:action>
				<xforms:action ev:event="xforms-submit-done">
					<!-- clear error message -->
					<xforms:setvalue ref="instance('control-instance')/error"></xforms:setvalue>

					<!-- evaluate namespace of returned XML document -->
					<xforms:action  if="namespace-uri(instance('oai-pmh')) = 'http://www.openarchives.org/OAI/2.0/'">
						<!-- insert harvester into master list and save it -->
						<xforms:insert context="instance('harvesters')" nodeset="./child::node()[last()]" origin="instance('harvester-template')"/>
						<xforms:send submission="save-harvesters"/>
						
						<!-- clear template -->
						<xforms:setvalue ref="instance('harvester-template')/@*"/>						
						
						<xforms:setvalue ref="instance('control-instance')/status">Extracting EAD document list.</xforms:setvalue>
					</xforms:action>					
					<xforms:setvalue ref="instance('control-instance')/error" if="not(namespace-uri(instance('oai-pmh')) = 'http://www.openarchives.org/OAI/2.0/')">The XML response
						does not belong to the OAI-PMH namespace.</xforms:setvalue>
				</xforms:action>
			</xforms:submission>

			<!-- XQuery -->
			<xforms:submission id="xquery-db" ref="instance('eXist-xquery')" resource="{instance('exist-config')/url}eaditor" method="post" replace="instance"
				instance="xquery-result" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:setvalue ref="instance('control-instance')/error" ev:event="xforms-submit-error">Error querying eXist database.</xforms:setvalue>
			</xforms:submission>


			<!-- ********** XFORMS-MODEL-CONSTRUCT-DONE ********** -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:action if="not(xxforms:is-user-in-role('eaditor-admin'))">
					<xforms:setvalue ref="instance('control-instance')/interface">unauthorized-user</xforms:setvalue>
				</xforms:action>
				<xforms:action if="xxforms:is-user-in-role('eaditor-admin')">
					<xforms:setvalue ref="instance('control-instance')/interface">harvester</xforms:setvalue>
					<xforms:send submission="load-config"></xforms:send>
					<xforms:send submission="load-collections"></xforms:send>
					<xforms:send submission="load-harvesters"></xforms:send>
				</xforms:action>
			</xforms:action>

			<!-- ************************* XFORMS-READY ************************** -->
			<!-- set case on xforms-ready -->
			<xforms:action ev:event="xforms-ready">
				<xforms:toggle case="{instance('control-instance')/interface}"></xforms:toggle>
			</xforms:action>
		</xforms:model>
	</head>

	<body>
		<xforms:var name="display_path">../</xforms:var>
		<xi:include href="header.xml"></xi:include>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<xforms:group ref="instance('control-instance')/error/text()">
						<div class="bg-danger alert-box">
							<span class="glyphicon glyphicon-info-sign"></span>
							<xforms:output ref="instance('control-instance')/error"></xforms:output>
						</div>
					</xforms:group>
					<xforms:group ref="instance('control-instance')/status/text()">
						<div class="bg-warning alert-box">
							<span class="glyphicon glyphicon-info-sign"></span>
							<xforms:output ref="instance('control-instance')/status"></xforms:output>
						</div>
					</xforms:group>
					<h1>EAD Harvester</h1>
					<xforms:switch>
						<xforms:case id="unauthorized-user">
							<p>The user is not authorized to access the EAD harvester. Only users in the eaditor-admin group can access this interface.</p>
						</xforms:case>
						<xforms:case id="harvester">
							<xforms:switch>
								<xforms:case id="harvester-list">
									<xforms:group ref="instance('harvesters')">
										<xforms:group ref=".[count(harvester) &gt; 0]">
											<table class="table">
												<thead>
													<tr>
														<th>Code</th>
														<th>Name</th>
														<th>Type</th>
														<th>URL</th>
														<th>Last Harvest</th>
													</tr>
												</thead>
												<tbody>
													<xforms:repeat nodeset="harvester">
														<xforms:var name="id" select="@collection"></xforms:var>
														<tr>
															<td><xforms:output ref="@collection"></xforms:output></td>
															<td><xforms:output ref="instance('xquery-result')//collection[@id=$id]/title"></xforms:output></td>
															<td><xforms:output ref="@type"/></td>
															<td><xforms:output ref="@url"/></td>
															<td><xforms:output value="if (string-length(@date) &gt; 0) then @date else 'Never harvested'"/></td>
														</tr>
													</xforms:repeat>
												</tbody>
											</table>
										</xforms:group>
										<xforms:group ref=".[count(harvester) = 0]">
											<p>There are no harvesters configured in EADitor.<xforms:trigger appearance="minimal"><xforms:label><span
															class="glyphicon glyphicon-plus"></span>Add one.</xforms:label>
													<xforms:toggle case="add-harvester" ev:event="DOMActivate"></xforms:toggle>
												</xforms:trigger></p>
										</xforms:group>
									</xforms:group>
								</xforms:case>
								<xforms:case id="add-harvester">
									<h3>Add Harvester</h3>
									<xforms:group ref="instance('harvester-template')">
										<div>
											<xforms:select1 ref="@collection">
												<xforms:label>Agency</xforms:label>
												<xforms:item>
													<xforms:label>Select Agency...</xforms:label>
													<xforms:value></xforms:value>
												</xforms:item>
												<xforms:itemset nodeset="instance('xquery-result')//collection">
													<xforms:label ref="concat(title, ' (', @id, ')')"></xforms:label>
													<xforms:value ref="@id"></xforms:value>
												</xforms:itemset>
												<xforms:alert>Required</xforms:alert>
											</xforms:select1>
										</div>
										<div>
											<xforms:select1 ref="@type" appearance="full">
												<xforms:label>Type</xforms:label>
												<xforms:item>
													<xforms:label>OAI-PMH</xforms:label>
													<xforms:value>oai</xforms:value>
												</xforms:item>
												<xforms:item>
													<xforms:label>Directory List</xforms:label>
													<xforms:value>directory</xforms:value>
												</xforms:item>
											</xforms:select1>
										</div>
										<div>
											<xforms:input ref="@url">
												<xforms:label>URL</xforms:label>
												<xforms:alert>Invalid URL</xforms:alert>
												<xforms:hint value="concat('Input URL for ', if (../@type='oai') then 'OAI-PMH set' else 'directory listing')"></xforms:hint>
											</xforms:input>
										</div> <xforms:trigger>
											<xforms:label>Validate</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:send submission="query-oai"></xforms:send>
											</xforms:action>
										</xforms:trigger>
									</xforms:group>
								</xforms:case>
							</xforms:switch>
						</xforms:case>
					</xforms:switch>
					<fr:xforms-inspector></fr:xforms-inspector>
				</div>
			</div>
		</div>
	</body>
</html>
