<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2010 Ethan Gruber
    EADitor: http://code.google.com/p/eaditor/
    Apache License 2.0: http://code.google.com/p/eaditor/    
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:ead="urn:isbn:1-931666-22-9"
	xmlns:saxon="http://saxon.sf.net/">
	<head>
		<title>EADitor: Edit Settings</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css"/>
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css"/>
		<link rel="stylesheet" href="/config/theme/examples.css" type="text/css" media="all"/>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico"/>
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png"/>
		<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.8.0/build/cssgrids/grids-min.css"/>

		<!-- EADitor styling -->
		<link rel="stylesheet" href="/apps/eaditor/xforms/css/xforms.css"/>

		<xforms:model xmlns="urn:isbn:1-931666-22-9">
			<xs:schema>
				<xs:simpleType name="emailAddress">
					<xs:restriction base="xs:string">
						<xs:pattern value="[^@]+@[^\.]+\..+"/>
					</xs:restriction>
				</xs:simpleType>
			</xs:schema>


			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"/>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<config xmlns=""/>
			</xforms:instance>

			<xforms:instance id="control-instance">
				<controls xmlns="">
					<collection-name/>
					<status/>
					<api-key-accepted/>
					<save-trigger/>
				</controls>
			</xforms:instance>

			<!-- authentication -->
			<xforms:instance id="collections-list" xxforms:exclude-result-prefixes="#all">
				<collections xmlns=""/>
			</xforms:instance>

			<xforms:instance id="dump">
				<dump xmlns=""/>
			</xforms:instance>

			<xforms:instance id="config-backup" xxforms:exclude-result-prefixes="#all">
				<config xmlns=""/>
			</xforms:instance>

			<xforms:instance id="config-template" xxforms:exclude-result-prefixes="#all">
				<config xmlns="" version="0.53">
					<firstrun/>
					<flickr_api_key>6210480b2fb5eb8b0eb1b6770fe921f6</flickr_api_key>
					<flickr_api_secret>31c3a70be753554e</flickr_api_secret>
					<geonames_api_key/>
					<title>EADitor</title>
					<publisher/>
					<publisher_code/>
					<publisher_email/>
					<description/>
					<license>http://opendatacommons.org/licenses/odbl/</license>
					<banner_text>EADitor: XForms for EAD</banner_text>
					<banner_image xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href=""/>
					<solr_published>http://localhost:8080/solr/eaditor-published/</solr_published>
					<url>http://localhost:8080/orbeon/eaditor/</url>
					<ark enabled="false">
						<naan/>
					</ark>
					<export>
						<oai-pmh>true</oai-pmh>
						<pelagios>false</pelagios>
					</export>
					<theme>
						<facets>agency_facet,century_num,corpname_facet,famname_facet,genreform_facet,geogname_facet,language_facet,persname_facet,subject_facet</facets>
						<jquery_ui_theme>smoothness</jquery_ui_theme>
					</theme>
					<machine_tags>
						<namespace id="geonames">
							<predicate>locality</predicate>
						</namespace>
						<namespace id="lcgft">
							<predicate>genreform</predicate>
						</namespace>
						<namespace id="lcsh">
							<predicate>subject</predicate>
						</namespace>
						<namespace id="pleiades">
							<predicate>atteststo</predicate>
							<predicate>depicts</predicate>
							<predicate>findspot</predicate>
							<predicate>origin</predicate>
							<predicate>place</predicate>
						</namespace>
						<namespace id="viaf">
							<predicate>depicts</predicate>
						</namespace>
					</machine_tags>
					<levels>
						<archdesc enabled="true"/>
						<level enabled="false">class</level>
						<level enabled="false">collection</level>
						<level enabled="false">file</level>
						<level enabled="false">fonds</level>
						<level enabled="false">item</level>
						<level enabled="false">otherlevel</level>
						<level enabled="false">recordgrp</level>
						<level enabled="false">series</level>
						<level enabled="false">subfonds</level>
						<level enabled="false">subgrp</level>
						<level enabled="false">subseries</level>
					</levels>
					<templates>
						<agencycodes>
							<agencycode value="US-default">Default Agency</agencycode>
						</agencycodes>
						<containertypes>
							<container value="box">Box</container>
							<container value="box-folder">Box-Folder</container>
							<container value="folder">Folder</container>
							<container value="reel">Reel</container>
							<container value="tape">Tape</container>
						</containertypes>
					</templates>
					<google_analytics>
						<script type="text/javascript"/>
					</google_analytics>
				</config>
			</xforms:instance>

			<!-- facets -->
			<xforms:instance id="facets" xxforms:exclude-result-prefixes="#all">
				<facets xmlns=""/>
			</xforms:instance>

			<xforms:instance id="facet-template">
				<facet xmlns=""/>
			</xforms:instance>

			<!-- flickr -->
			<xforms:instance id="flickr-response">
				<rsp xmlns=""/>
			</xforms:instance>

			<xforms:instance id="secret-template" xxforms:exclude-result-prefixes="#all">
				<flickr_api_secret xmlns=""/>
			</xforms:instance>

			<!-- jQuery UI themes -->
			<xforms:instance id="jquery-ui-themes">
				<themes xmlns="">
					<theme>base</theme>
					<theme>black-tie</theme>
					<theme>blitzer</theme>
					<theme>cupertino</theme>
					<theme>dark-hive</theme>
					<theme>dot-luv</theme>
					<theme>eggplant</theme>
					<theme>excite-bike</theme>
					<theme>flick</theme>
					<theme>hot-sneaks</theme>
					<theme>humanity</theme>
					<theme>le-frog</theme>
					<theme>mint-choc</theme>
					<theme>overcast</theme>
					<theme>pepper-grinder</theme>
					<theme>redmond</theme>
					<theme>smoothness</theme>
					<theme>south-street</theme>
					<theme>start</theme>
					<theme>sunny</theme>
					<theme>swanky-purse</theme>
					<theme>trontastic</theme>
					<theme>ui-darkness</theme>
					<theme>ui-lightness</theme>
					<theme>vader</theme>
				</themes>
			</xforms:instance>

			<xforms:bind nodeset="instance('config')">
				<xforms:bind nodeset="title" required="true()"/>
				<xforms:bind nodeset="description" required="../export/pelagios = true()" readonly="../export/pelagios = false()"/>
				<xforms:bind nodeset="theme/jquery_ui_theme" required="true()"/>
				<xforms:bind nodeset="solr_published" required="true()" as="xs:anyURI"/>
				<xforms:bind nodeset="url" required="true()" as="xs:anyURI"/>
				<xforms:bind nodeset="ark">
					<xforms:bind nodeset="naan" constraint="string-length(.) = 5 and number(.)" readonly="parent::node()/@enabled = false()"/>
					<xforms:bind nodeset="@enabled" type="xs:boolean"/>
				</xforms:bind>
				<xforms:bind nodeset="export">
					<xforms:bind nodeset="oai-pmh" type="xs:boolean"/>
					<xforms:bind nodeset="pelagios" type="xs:boolean"/>
				</xforms:bind>
				<xforms:bind nodeset="levels">
					<xforms:bind nodeset="archdesc/@enabled" type="xs:boolean"/>
					<xforms:bind nodeset="level/@enabled" type="xs:boolean"/>
				</xforms:bind>
				<xforms:bind nodeset="publisher" required="../export/oai-pmh = true() or ../export/pelagios = true()"/>
				<xforms:bind nodeset="publisher_code" required="../export/oai-pmh = true()" readonly="../export/oai-pmh = false()"/>
				<xforms:bind nodeset="publisher_email" type="emailAddress" required="../export/oai-pmh = true()" readonly="../export/oai-pmh = false()"/>
			</xforms:bind>

			<xforms:bind nodeset="instance('control-instance')/save-trigger" readonly="instance('control-instance')/api-key-accepted = 'false'"/>
			<xforms:bind id="visual-tab" nodeset="instance('config')/theme"/>

			<!-- submissions -->
			<xforms:submission id="load-collections" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/collections-list.xml" replace="instance" instance="collections-list"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<!-- if the config loads successfully, set the collection names based on authentication -->
				<xforms:action ev:event="xforms-submit-done">
					<!-- set default if security is false -->
					<xforms:action if="not(string(instance('control-instance')/request-security/role))">
						<xforms:setvalue ref="instance('control-instance')/collection-name">default</xforms:setvalue>
					</xforms:action>
					<!-- if there is a security role, set the collection-name value if it is in the list, otherwise set new collection name -->
					<xforms:action if="string(instance('control-instance')/request-security/role)">
						<xforms:action if="string(instance('collections-list')/collection[@role=instance('control-instance')/request-security/role]/@name)">
							<xforms:setvalue ref="instance('control-instance')/collection-name"
								value="instance('collections-list')/collection[@role=instance('control-instance')/request-security/role]/@name"/>
						</xforms:action>
					</xforms:action>
					<xforms:send submission="load-config"/>

					<!-- set facets instance -->
					<xforms:action xxforms:iterate="tokenize(instance('config')/theme/facets, ',')">
						<xforms:insert context="instance('facets')" nodeset="./child::node()[last()]" origin="instance('facet-template')"/>
						<xforms:setvalue ref="instance('facets')/facet[last()]" value="context()"/>
					</xforms:action>
				</xforms:action>
				<!-- if the config has not been created (given that the URL in exist-url.xml is correct), create it -->
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load EADitor collections list.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/config.xml"
				replace="instance" instance="config" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error loading config.</xforms:message>
			</xforms:submission>

			<xforms:submission id="save-config" ref="instance('config')" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/config.xml" method="put"
				replace="none" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Config.</xforms:message>
				<xforms:setvalue ref="instance('status')" ev:event="xforms-submit-done">EADitor configuration saved.</xforms:setvalue>
			</xforms:submission>

			<!-- test for flickr echo -->
			<xforms:submission id="test-for-echo" serialization="none" method="get"
				action="http://api.flickr.com/services/rest/?method=flickr.test.echo&amp;api_key={instance('config')/flickr_api_key}" replace="instance" instance="flickr-response">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error querying flickr. Please check internet connection.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<!-- set readonly for save button if the api key is a string and failed -->
					<xforms:setvalue ref="instance('control-instance')/api-key-accepted" if="not(instance('flickr-response')/@stat = 'ok') and string-length(instance('config')/flickr_api_key) &gt; 0"
						value="'false'"/>

					<!-- activate button if the api key is okay or blank -->
					<xforms:setvalue ref="instance('control-instance')/api-key-accepted" if="instance('flickr-response')/@stat = 'ok' or string-length(instance('config')/flickr_api_key) = 0"
						value="'true'"/>
				</xforms:action>
			</xforms:submission>

			<!-- load eaditor config file on xforms construction -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:insert context="instance('control-instance')" nodeset="collection-name" position="after"
					origin="xxforms:call-xpl('oxf:/apps/eaditor/xpl/get-authentication.xpl', 'dump', instance('dump'), 'data')"/>
				<xforms:send submission="load-collections"/>
			</xforms:action>
		</xforms:model>
	</head>

	<body>
		<div class="yui3-g">
			<div class="yui3-u-1">
				<div class="content">
					<!-- header -->
					<xforms:var name="display_path">../</xforms:var>
					<xi:include href="header.xml"/>
					<div id="form">
						<xforms:group ref="instance('status')/text()">
							<div class="success">
								<xforms:output ref="instance('status')"/>
							</div>
						</xforms:group>
						<p>
							<a href="{$display_path}">&lt; Return</a>
						</p>
						<div class="submission">
							<xforms:trigger ref="instance('control-instance')/save-trigger" appearance="minimal">
								<xforms:label><img src="/apps/eaditor/xforms/images/save.gif" alt="Save"/> Save</xforms:label>
								<xforms:action ev:event="DOMActivate">
									<!-- first re-assemble the facets template into comma separated values into the config -->
									<xforms:setvalue ref="instance('config')/theme/facets" value="string-join(instance('facets')/facet, ',')"/>
									<!-- then save the config to eXist -->
									<xforms:send submission="save-config"/>
								</xforms:action>
							</xforms:trigger>
						</div>
						<h1>EADitor Settings</h1>
						<div>
							<xforms:output ref="instance('config')/@version">
								<xforms:label>Version</xforms:label>
							</xforms:output>
						</div>
						<fr:tabview>
							<!--**************************************** CONFIGURATION **********************************-->
							<fr:tab id="configure-tab">
								<fr:label>Configuration</fr:label>
								<h2>Configuration</h2>
								<xforms:group ref="instance('config')">
									<div class="section">
										<h3>Titles and URLs</h3>
										<div>
											<xforms:input ref="title">
												<xforms:label>Title</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<p>The title of the site to be displayed in all web page titles and citations in PDF files.</p>
										</div>
										<div>
											<xforms:input ref="publisher">
												<xforms:label>Publisher</xforms:label>
												<xforms:alert>Required if Pelagios or OAI-PMH export are enabled.</xforms:alert>
											</xforms:input>
											<p>Publisher (individual institution or consortium) responsible for publishing content.</p>
										</div>
										<div>
											<xforms:input ref="banner_text">
												<xforms:label>Banner Text</xforms:label>
											</xforms:input>
											<p>Appears in the header banner. For more sophisticated control, edit header.xsl.</p>
										</div>
										<div>
											<xforms:input ref="url">
												<xforms:label>URL</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<p>Public URL of the site. This is used for forming links to the XML and HTML versions of finding aids, should the public and private aspects of EADitor be
												contained on different servers.</p>
										</div>
										<!--<xforms:group ref="banner_image">
										<numishare:banner-upload/>
										</xforms:group>-->
									</div>
									<div class="section">
										<h3>ARK</h3>
										<p>The Name Assigning Authority Number (NAAN) may be inputted here and enabled to activate the Archival Resource Key (ARK)-compliant URI: <xforms:output
												value="concat(url, 'ark:/', if(string(ark/naan)) then ark/naan else '{NAAN}', '/{recordid}')"/></p>
										<div>
											<xforms:input ref="ark/@enabled">
												<xforms:label>Enabled</xforms:label>
											</xforms:input>
										</div>
										<div>
											<xforms:input ref="ark/naan">
												<xforms:label>NAAN</xforms:label>
												<xforms:alert>Must be a 5-digit ARK number.</xforms:alert>
											</xforms:input>
										</div>
									</div>
									<div class="section">
										<h3>Export</h3>
										<div class="subsection">
											<h4>OAI-PMH</h4>
											<p>Activate OAI-PMH to enable a link on the index page. The feed validates to OAI protocal at the YYYY-MM-DD granularity. <b>Important: </b> Validation only
												passes if EADitor is run on an external server (i.e., not localhost) which uses Apache proxying to make the :8080 Tomcat port. The OAI unique identifier
												is derived from the URL on this settings page.</p>
											<div>
												<xforms:input ref="export/oai-pmh">
													<xforms:label>Enabled</xforms:label>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="publisher_code">
													<xforms:label>Publisher Code</xforms:label>
													<xforms:alert>Required if OAI-PMH export is enabled.</xforms:alert>
												</xforms:input>
												<p>Publisher code used for OAI-PMH export.</p>
											</div>
											<div>
												<xforms:input ref="publisher_email">
													<xforms:label>Publisher Email</xforms:label>
													<xforms:alert>Required if OAI-PMH export is enabled.</xforms:alert>
												</xforms:input>
												<p>Publisher email used for OAI-PMH export.</p>
											</div>
										</div>
										<div class="subsection">
											<h4>Pelagios</h4>
											<p>This activates the link to the Pelagios VOiD dataset on the EADitor front page. The content of the data dump will only contain RDF documents for objects
												which have been tied to Pleiades IDs.</p>
											<div>
												<xforms:input ref="export/pelagios">
													<xforms:label>Enabled</xforms:label>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="description">
													<xforms:label>Description</xforms:label>
													<xforms:alert>Required of Pelagios export is enabled.</xforms:alert>
												</xforms:input>
												<p>This is the description of the VOiD dataset exported for Pelagios.</p>
											</div>
										</div>
									</div>
									<div class="section">
										<h3>Publication Options</h3>
										<p>Individual components may be published as atomized Solr documents for more relevant query results and component-level RDF export.</p>
										<xforms:group ref="levels">
											<div>
												<xforms:input ref="archdesc/@enabled">
													<xforms:label>Finding Aid</xforms:label>
												</xforms:input>
											</div>
											<h4>Components</h4>
											<xforms:repeat nodeset="level">
												<xforms:var name="label" select="."/>
												<div>
													<xforms:input ref="@enabled">
														<xforms:label ref="concat('Level: ', $label)"/>
													</xforms:input>
												</div>
											</xforms:repeat>
										</xforms:group>
									</div>
									<div class="section">
										<h3>API Keys</h3>
										<xforms:group ref=".[instance('flickr-response')/@stat='fail' and string-length(flickr_api_key) &gt; 0]">
											<div class="ui-widget">
												<div class="ui-state-error ui-corner-all">
													<p>
														<span class="ui-icon ui-icon-alert" style="float: left; margin-right: 0.3em;"/>
														<strong>Alert:</strong>
														<xforms:output ref="instance('flickr-response')/err/@msg"/>
													</p>
												</div>
											</div>
										</xforms:group>
										<div>
											<xforms:input ref="flickr_api_key" incremental="true">
												<xforms:label>flickr API Key</xforms:label>
												<xforms:send submission="test-for-echo" ev:event="xforms-value-changed"/>
											</xforms:input>
											<p>A <a href="http://www.flickr.com/services/api/misc.api_keys.html">flickr API key</a> is required in order to take advantage of flickr image linking.</p>
										</div>
										<div>
											<xforms:input ref="flickr_api_secret" incremental="true">
												<xforms:label>flickr API Secret</xforms:label>
											</xforms:input>
											<p>A <a href="http://www.flickr.com/services/api/misc.api_keys.html">flickr API secret</a> is required to insert tags through EADitor.</p>
										</div>
										<div>
											<xforms:input ref="geonames_api_key" incremental="true">
												<xforms:label>Geonames API Key</xforms:label>
											</xforms:input>
										</div>
									</div>
									<div class="section">
										<h3>Google Analytics</h3>
										<p>Copy and paste Javascript code provided by Google Analytics here.</p>
										<div>
											<xforms:textarea ref="google_analytics/script">
												<xforms:label>Code</xforms:label>
											</xforms:textarea>
										</div>
									</div>
								</xforms:group>
							</fr:tab>
							<!--**************************************** THEMES AND LAYOUT **********************************-->
							<fr:tab bind="visual-tab">
								<fr:label>Themes and Layout</fr:label>
								<div class="section">
									<h2>Theme</h2>
									<div>
										<xforms:select1 ref="jquery_ui_theme">
											<xforms:label>jQuery UI Theme</xforms:label>
											<xforms:alert>Required</xforms:alert>
											<xforms:itemset nodeset="instance('jquery-ui-themes')/theme">
												<xforms:label ref="."/>
												<xforms:value ref="."/>
											</xforms:itemset>
										</xforms:select1>
									</div>
								</div>
								<div class="section">
									<h2>Facets</h2>
									<span class="add">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="/apps/eaditor/xforms/images/add.gif"/>Facet </xforms:label>
											<xforms:insert context="instance('facets')" nodeset="./child::node()[last()]" origin="instance('facet-template')" ev:event="DOMActivate"/>
										</xforms:trigger>
									</span>
									<p>The facet must be a valid Solr string-based field (preferably defined by the *_facet dynamicField type in the schema). An invalid field will cause the browse and
										map pages to fail. Note that the order of the facets below dictates the order in which they appear on the browse and maps pages.</p>
									<xforms:repeat nodeset="instance('facets')/facet">
										<xforms:var name="position" select="position()"/>
										<div>
											<xforms:input ref=".">
												<xforms:label>Facet</xforms:label>
											</xforms:input>
											<xforms:group ref=".[$position != 1]">
												<xforms:trigger appearance="minimal">
													<xforms:label><img alt="up" src="/eaditor/xforms/xbl/tree-view/images/up.gif"/></xforms:label>
													<xforms:action ev:event="DOMActivate">
														<xforms:insert context="instance('facets')" nodeset="facet[$position - 2]" origin="instance('facets')/facet[$position]"/>
														<xforms:delete nodeset="."/>
													</xforms:action>
												</xforms:trigger>
											</xforms:group>
											<xforms:group ref=".[not($position=count(instance('facets')/facet))]">
												<xforms:trigger appearance="minimal">
													<xforms:label><img alt="down" src="/eaditor/xforms/xbl/tree-view/images/down.gif"/></xforms:label>
													<xforms:action ev:event="DOMActivate">
														<xforms:insert context="instance('facets')" nodeset="facet[$position+1]" origin="instance('facets')/facet[$position]"/>
														<xforms:delete nodeset="."/>
													</xforms:action>
												</xforms:trigger>
											</xforms:group>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" context="."/>
												<xforms:label>
													<img src="/apps/eaditor/xforms/images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
										</div>
									</xforms:repeat>
								</div>
							</fr:tab>
							<!--**************************************** ADVANCED SETTINGS **********************************-->
							<fr:tab id="advanced">
								<fr:label>Advanced</fr:label>
								<xforms:group ref="instance('config')">
									<h3>Advanced Settings</h3>
									<div class="section">
										<p>
											<b>Only change these options if Orbeon is run on a separate server.</b>
										</p>
										<p>Changing these options to an inactive URL could break public display and web form functionality.</p>
										<div class="subsection">
											<h4>Solr URLs</h4>
											<div>
												<xforms:input ref="solr_published">
													<xforms:label>Published</xforms:label>
													<xforms:alert>Required</xforms:alert>
												</xforms:input>
											</div>
										</div>
									</div>
								</xforms:group>
							</fr:tab>
						</fr:tabview>
					</div>
					<!--<fr:xforms-inspector/>-->
				</div>
			</div>
		</div>
	</body>
</html>
