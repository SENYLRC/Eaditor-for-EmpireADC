<?xml version="1.0" encoding="utf-8"?>
<!--
	Copyright (C) 2010 Ethan Gruber
	EADitor: https://github.com/ewg118/eaditor
	Apache License 2.0: https://github.com/ewg118/eaditor    
-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:widget="http://orbeon.org/oxf/xml/widget" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:exist="http://exist.sourceforge.net/NS/exist" xmlns:ead="urn:isbn:1-931666-22-9">
	<head>
		<title>EADitor: Edit Agency Codes</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css"/>
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css"/>
		<link rel="stylesheet" href="/config/theme/examples.css" type="text/css" media="all"/>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico"/>
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png"/>
		<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.8.0/build/cssgrids/grids-min.css"/>

		<!-- EADitor styling -->
		<link rel="stylesheet" href="/apps/eaditor/xforms/css/xforms.css"/>

		<xforms:model schema="http://www.loc.gov/ead/ead.xsd">
			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-config">
				<xi:include href="../exist-config.xml"/>
			</xforms:instance>

			<xforms:instance id="config">
				<config xmlns=""/>
			</xforms:instance>
			
			<xforms:instance id="control-instance">
				<controls xmlns="">
					<collection-name/>
					<status/>
					<query/>
					<error/>
					<formatted-result/>
				</controls>
			</xforms:instance>
			
			<!-- authentication -->
			<xforms:instance id="collections-list" xxforms:exclude-result-prefixes="#all">
				<collections xmlns=""/>
			</xforms:instance>
			
			<xforms:instance id="dump">
				<dump xmlns=""/>
			</xforms:instance>

			<!-- templates -->
			<xforms:instance id="agencycode-template" xxforms:exclude-result-prefixes="#all">
				<agencycode value="" xmlns=""/>
			</xforms:instance>

			<xforms:instance id="container-template" xxforms:exclude-result-prefixes="#all">
				<container value="" xmlns=""/>
			</xforms:instance>

			<xforms:instance id="temp-instance">
				<temp xmlns=""/>
			</xforms:instance>

			<!-- eXist XQuery for localized agencycodes -->
			<xforms:instance id="agencycodes-instance">
				<exist:query xmlns="">
					<exist:text>&lt;report> { for $foo in collection() return $foo//*[local-name()='eadid'] } &lt;/report></exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="response-instance">
				<exist:result/>
			</xforms:instance>

			<xforms:bind nodeset="instance('config')/templates">
				<xforms:bind nodeset="agencycodes">
					<xforms:bind nodeset="agencycode/@value" required="true()" type="ead:data.repositorycode"/>
					<xforms:bind nodeset="agencycode" required="true()"/>
				</xforms:bind>
				<xforms:bind nodeset="containertypes">
					<xforms:bind nodeset="container/@value" required="true()" type="xs:NMTOKEN"/>
					<xforms:bind nodeset="container" required="true()"/>
				</xforms:bind>
			</xforms:bind>

			<xforms:bind id="agencycodes-tab" nodeset="instance('config')/templates/agencycodes"/>
			<xforms:bind id="containertypes-tab" nodeset="instance('config')/templates/containertypes"/>

			<!-- authentication and config submissions -->
			<xforms:submission id="load-collections" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/collections-list.xml" replace="instance" instance="collections-list"
				xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<!-- if the config loads successfully, set the collection names based on authentication -->
				<xforms:action ev:event="xforms-submit-done">
					<!-- set default if security is false -->
					<xforms:action if="not(string(instance('control-instance')/request-security/role))">
						<xforms:setvalue ref="instance('control-instance')/collection-name">default</xforms:setvalue>
					</xforms:action>
					<!-- if there is a security role, set the collection-name value if it is in the list, otherwise set new collection name -->
					<xforms:action if="string(instance('control-instance')/request-security/role)">
						<xforms:action if="string(instance('collections-list')/collection[@role=instance('control-instance')/request-security/role]/@name)">
							<xforms:setvalue ref="instance('control-instance')/collection-name"
								value="instance('collections-list')/collection[@role=instance('control-instance')/request-security/role]/@name"/>
						</xforms:action>
					</xforms:action>
					<xforms:send submission="load-config"/>
				</xforms:action>
				<!-- if the config has not been created (given that the URL in exist-url.xml is correct), create it -->
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load EADitor collections list.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/config.xml"
				replace="instance" instance="config" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error loading config.</xforms:message>
			</xforms:submission>
			
			<xforms:submission id="save-config" ref="instance('config')" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/config.xml" method="put" replace="none" xxforms:username="{instance('exist-config')/username}" xxforms:password="{instance('exist-config')/password}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Config.</xforms:message>
				<xforms:setvalue ref="instance('control-instance')/status" ev:event="xforms-submit-done">EADitor configuration saved.</xforms:setvalue>
			</xforms:submission>
			
			<!-- xqueries -->
			<xforms:submission id="agencycodes-submission" ref="instance('agencycodes-instance')" action="{instance('exist-config')/url}eaditor/{instance('control-instance')/collection-name}/guides" method="post"
				replace="instance" instance="response-instance">
				<xforms:insert nodeset="instance('temp-instance')" ev:event="xforms-submit-done"
					origin="xxforms:call-xpl('oxf:/apps/eaditor/xpl/get-agencycodes.xpl', 'data', instance('response-instance'), 'data')"/>
				<xforms:action xxforms:iterate="instance('temp-instance')/agencycode" ev:event="xforms-submit-done">
					<xforms:insert context="instance('config')/templates/agencycodes" nodeset="./child::node()[last()]" origin="instance('agencycode-template')"/>
					<xforms:setvalue ref="instance('config')/templates/agencycodes/agencycode[last()]" value="context()"/>
					<xforms:setvalue ref="instance('config')/templates/agencycodes/agencycode[last()]/@value" value="context()"/>
				</xforms:action>
			</xforms:submission>

			<!-- ************************ xforms-model-construct-done ****************************** -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:insert context="instance('control-instance')" nodeset="collection-name" position="after"
					origin="xxforms:call-xpl('oxf:/apps/eaditor/xpl/get-authentication.xpl', 'dump', instance('dump'), 'data')"/>
				<xforms:send submission="load-collections"/>
			</xforms:action>
		</xforms:model>
	</head>
	<body>
		<div class="yui3-g">
			<div class="yui3-u-1">
				<div class="content">
					<xforms:var name="display_path">../../</xforms:var>
					<xi:include href="header.xml"/>
					
					<xforms:group ref="instance('control-instance')/status/text()">
						<div class="success">
							<xforms:output ref="instance('control-instance')/status"/>
						</div>
					</xforms:group>
					<p>
						<a href="{$display_path}templates/">&lt; Return</a>
					</p>
					<!-- This table contains the main actions for the page  -->
					<div class="submission">
						<xforms:submit submission="save-config" appearance="minimal">
							<xforms:label><img src="/apps/eaditor/xforms/images/save.gif" alt="Save"/> Save</xforms:label>
						</xforms:submit>
						<xforms:submit submission="load-config" appearance="minimal">
							<xforms:label><img src="/apps/eaditor/xforms/images/recycle-green.png" alt="Revert"/>Load</xforms:label>
						</xforms:submit>
					</div>
					<h1>Edit Instance Templates</h1>
					<fr:tabview>
						<fr:tab bind="agencycodes-tab">
							<fr:label>Agency Codes</fr:label>
							<h2>Agency Codes</h2>
							<xforms:trigger appearance="minimal">
								<xforms:label>
									<img src="/apps/eaditor/xforms/images/add.gif"/>New Agency</xforms:label>
								<xforms:insert ev:event="DOMActivate" context="." nodeset="./child::node()[last()]" origin="instance('agencycode-template')"/>
							</xforms:trigger>
							<xforms:trigger appearance="minimal">
								<xforms:label><img src="/apps/eaditor/xforms/images/add.gif"/>Import Local Agencies</xforms:label>
								<xforms:action ev:event="DOMActivate">
									<xforms:send submission="agencycodes-submission"/>
								</xforms:action>
							</xforms:trigger>
							<xforms:repeat nodeset="agencycode">
								<div class="pair_div">
									<div>
										<xforms:input ref=".">
											<xforms:label>Agency</xforms:label>
											<xforms:alert>Required</xforms:alert>
										</xforms:input>
									</div>
									<div>
										<xforms:input ref="@value">
											<xforms:label>Code</xforms:label>
											<xforms:alert>The value is required and must meet the schema specification for the data.repositorycode type.</xforms:alert>
										</xforms:input>
									</div>
									<xforms:group ref=".[count(//agencycode) &gt; 1]">
										<xforms:trigger appearance="minimal" style="float:right">
											<xforms:delete ev:event="DOMActivate" nodeset="."/>
											<xforms:label>
												<img src="/apps/eaditor/xforms/images/remove.gif"/>
											</xforms:label>
										</xforms:trigger>
									</xforms:group>
								</div>
							</xforms:repeat>
						</fr:tab>
						<fr:tab bind="containertypes-tab">
							<fr:label>Container Types</fr:label>
							<h2>Container Types</h2>
							<xforms:trigger appearance="minimal">
								<xforms:label>
									<img src="/apps/eaditor/xforms/images/add.gif"/>New Container</xforms:label>
								<xforms:insert ev:event="DOMActivate" context="." nodeset="./child::node()[last()]" origin="instance('container-template')"/>
							</xforms:trigger>
							<!--<xforms:trigger appearance="minimal">
								<xforms:label><img src="/apps/eaditor/xforms/images/add.gif"/>Import Local Container Types</xforms:label>
								<xforms:action ev:event="DOMActivate">
									<xforms:send submission="containertypes-submission"/>
								</xforms:action>
							</xforms:trigger>-->
							<xforms:repeat nodeset="container">
								<div class="pair_div">
									<div>
										<xforms:input ref=".">
											<xforms:label>Container</xforms:label>
											<xforms:alert>Required</xforms:alert>
										</xforms:input>
									</div>
									<div>
										<xforms:input ref="@value">
											<xforms:label>Level</xforms:label>
											<xforms:alert>Required; must be xs:NMTOKEN type</xforms:alert>
										</xforms:input>
									</div>
									<xforms:group ref=".[count(//container) &gt; 1]">
										<xforms:trigger appearance="minimal" style="float:right">
											<xforms:delete ev:event="DOMActivate" nodeset="."/>
											<xforms:label>
												<img src="/apps/eaditor/xforms/images/remove.gif"/>
											</xforms:label>container
										</xforms:trigger>
									</xforms:group>
								</div>
							</xforms:repeat>
						</fr:tab>
					</fr:tabview>
					<!--<widget:xforms-instance-inspector id="orbeon-xforms-inspector"
					xmlns:widget="http://orbeon.org/oxf/xml/widget"/>-->
				</div>
			</div>
		</div>
	</body>
</html>
